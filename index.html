<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigma AR Launcher Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 
        *** IMPORTANT CHANGE HERE ***
        Switched to unpkg.com CDN for MindAR to resolve the "failed to load" error.
        This is a common fix when jsdelivr (used previously) is blocked by a network or firewall.
    -->
    <script src="https://unpkg.com/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        /* Modern, mobile-first styling for the container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            width: 100%;
            padding: 30px;
            background-color: #161b22;
            border-radius: 12px;
            box-shadow: 0 4px 60px rgba(0, 200, 255, 0.2);
            text-align: center;
        }
        .error-box {
            background-color: #330c0c;
            border: 1px solid #ff4d4d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .success-box {
            background-color: #0c3316;
            border: 1px solid #4dff4d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        /* Hide the AR scene initially */
        a-scene {
            display: none; 
            width: 100%; 
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-xl font-bold mb-4">MindAR Diagnostic Test</h1>
        <p class="text-sm text-gray-400 mb-6">Checking camera access and AR library integrity.</p>

        <button id="startButton" 
                class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out">
            Start AR Experience
        </button>

        <div id="statusMessage" class="error-box mt-4 hidden">
            <p id="errorText" class="font-mono text-xs"></p>
        </div>
        
        <!-- The MindAR A-Frame scene, hidden until started -->
        <!-- NOTE: targets.mind is still required in the same directory -->
        <a-scene id="arScene" mindar-image="imageTargetSrc: targets.mind; filterMinCF:0.0001; filterBeta: 0.001; maxTrack: 2;" embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights: true" vr-mode-ui="enabled: false" device-orientation-permission-required="true">
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const arScene = document.getElementById('arScene');
        const statusMessage = document.getElementById('statusMessage');
        const errorText = document.getElementById('errorText');

        const initializeAR = () => {
            // First, try to remove the 'display: none' and append the scene to the DOM
            arScene.style.display = 'block'; 
            
            // Perform a quick check to see if the MindAR library loaded after the button click
            if (typeof MindAR === 'undefined' || typeof MindAR.Image === 'undefined') {
                 showError("CRITICAL: MindAR library failed to load from CDN. This may be a network block. Check the console for CORS errors.");
                 // Immediately hide the button if the library itself is missing
                 startButton.style.display = 'none';
                 return;
            }

            statusMessage.classList.remove('error-box');
            statusMessage.classList.add('success-box');
            showError("MindAR library loaded successfully. Attempting to request camera permission...");
            
            // Set up event listeners for the A-Frame component initialization
            arScene.addEventListener('mindar-image-initialized', () => {
                showSuccess("AR Initialized! Please point your camera at the target image.");
            });

            // Handle the camera access error
            arScene.addEventListener('camera-error', (event) => {
                let errorMessage = event.detail.error.name || "Unknown Error";
                // This is the error code that typically means COOP/COEP headers are missing
                if (errorMessage === 'NotAllowedError') {
                    showError("Error: Camera Access Blocked (NotAllowedError). This is the Cross-Origin Isolation issue common on GitHub Pages. You must switch hosting (e.g., to Netlify) to set COOP/COEP headers.");
                } else if (errorMessage === 'NotFoundError') {
                    showError("Error: No camera or media device found on this device.");
                } else {
                    showError(`Camera failed to start: ${errorMessage}. Check browser settings.`);
                }
                console.error("Camera Error Details:", event.detail.error);
                arScene.style.display = 'none'; // Hide scene on failure
                startButton.style.display = 'block'; // Show button to retry
            });

            // Hide the button and let A-Frame/MindAR handle the process
            startButton.style.display = 'none';
        };

        const showError = (message) => {
            statusMessage.classList.remove('hidden', 'success-box');
            statusMessage.classList.add('error-box');
            errorText.innerText = message;
        }

        const showSuccess = (message) => {
            statusMessage.classList.remove('hidden', 'error-box');
            statusMessage.classList.add('success-box');
            errorText.innerText = message;
        }

        startButton.addEventListener('click', initializeAR);
        
        window.addEventListener('load', () => {
            // Check if the script loaded immediately on page load
            if (typeof MindAR === 'undefined' || typeof MindAR.Image === 'undefined') {
                 showError("MindAR library failed to load immediately on page load. Network or firewall block suspected.");
            }
        });

    </script>
</body>
</html>
