<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebAR Editor - No-Code AR Builder</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    // Lucide React Icons (inline SVG components)
    const Upload = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="17 8 12 3 7 8" />
        <line x1="12" y1="3" x2="12" y2="15" />
      </svg>
    );

    const Download = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
    );

    const Trash2 = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6" />
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
        <line x1="10" y1="11" x2="10" y2="17" />
        <line x1="14" y1="11" x2="14" y2="17" />
      </svg>
    );

    const Image = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
        <circle cx="8.5" cy="8.5" r="1.5" />
        <polyline points="21 15 16 10 5 21" />
      </svg>
    );

    const Video = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="23 7 16 12 23 17 23 7" />
        <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
      </svg>
    );

    const Box = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
        <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
        <line x1="12" y1="22.08" x2="12" y2="12" />
      </svg>
    );

    const Type = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="4 7 4 4 20 4 20 7" />
        <line x1="9" y1="20" x2="15" y2="20" />
        <line x1="12" y1="4" x2="12" y2="20" />
      </svg>
    );

    const AREditor = () => {
      const [targetImage, setTargetImage] = useState(null);
      const [elements, setElements] = useState([]);
      const [selectedElement, setSelectedElement] = useState(null);
      
      // New State for Required External Files
      const [targetsMindUrl, setTargetsMindUrl] = useState('./targets.mind');
      const [motionCardUrl, setMotionCardUrl] = useState('./motion-card.gif');
      
      const fileInputRef = useRef(null);

      // Utility function to trigger a file download
      const downloadFile = (data, filename, type) => {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setTargetImage(event.target.result);
          };
          reader.readAsDataURL(file);
        }
      };

      const addElement = (type) => {
        const newElement = {
          id: Date.now(),
          type,
          position: { x: 0, y: 0, z: 0 },
          rotation: { x: 0, y: 0, z: 0 },
          scale: 1,
          content: type === 'text' ? 'Sample Text' : '',
          url: ''
        };
        setElements([...elements, newElement]);
        setSelectedElement(newElement.id);
      };

      const updateElement = (id, updates) => {
        setElements(elements.map(el => 
          el.id === id ? { ...el, ...updates } : el
        ));
      };

      const deleteElement = (id) => {
        setElements(elements.filter(el => el.id !== id));
        if (selectedElement === id) setSelectedElement(null);
      };

      const exportProject = () => {
        const project = {
          targetImage,
          elements,
          targetsMindUrl, // Include in project export
          motionCardUrl, // Include in project export
          timestamp: new Date().toISOString()
        };
        downloadFile(JSON.stringify(project, null, 2), 'ar-project.json', 'application/json');
      };

      const generateHTML = (targetsMindPath, motionCardPath) => {
        return `<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body { margin: 0; }
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: Arial, sans-serif;
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="loading">Loading AR Experience...</div>
  
  <a-scene mindar-image="imageTargetSrc: ${targetsMindPath}; autoStart: true;" 
           color-space="sRGB" 
           renderer="colorManagement: true, physicallyCorrectLights" 
           vr-mode-ui="enabled: false" 
           device-orientation-permission-ui="enabled: false">
    
    <a-assets>
      ${motionCardPath ? `      <img id="motionCard" src="${motionCardPath}" crossorigin="anonymous" />` : ''}

${elements.filter(el => el.url).map((el, i) => {
  // Use a predictable ID for assets, like 'asset' + element.id
  const assetId = 'asset' + el.id; 
  if (el.type === 'image') return `      <img id="${assetId}" src="${el.url}" crossorigin="anonymous" />`;
  if (el.type === 'video') return `      <video id="${assetId}" src="${el.url}" autoplay loop crossorigin="anonymous"></video>`;
  if (el.type === 'model') return `      <a-asset-item id="${assetId}" src="${el.url}" crossorigin="anonymous"></a-asset-item>`;
  return '';
}).join('\n')}
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    
    <a-entity mindar-image-target="targetIndex: 0">
${elements.map((el, i) => {
  const pos = `${el.position.x} ${el.position.y} ${el.position.z}`;
  const rot = `${el.rotation.x} ${el.rotation.y} ${el.rotation.z}`;
  const scale = `${el.scale} ${el.scale} ${el.scale}`;
  const assetId = 'asset' + el.id; // Match the asset ID in a-assets
  
  if (el.type === 'image' && el.url) {
    return `      <a-image src="#${assetId}" position="${pos}" rotation="${rot}" scale="${scale}" look-at="[camera]"></a-image>`;
  } else if (el.type === 'video' && el.url) {
    return `      <a-video src="#${assetId}" position="${pos}" rotation="${rot}" scale="${scale}" width="1" height="0.5625"></a-video>`; // Added size for video
  } else if (el.type === 'model' && el.url) {
    return `      <a-gltf-model src="#${assetId}" position="${pos}" rotation="${rot}" scale="${scale}"></a-gltf-model>`;
  } else if (el.type === 'text') {
    return `      <a-text value="${el.content}" position="${pos}" rotation="${rot}" scale="${scale}" color="#FFF" align="center" width="2"></a-text>`; // Added width for better text scaling
  }
  return '';
}).join('\n')}
    </a-entity>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const sceneEl = document.querySelector('a-scene');
      
      // Error handling for initialization
      sceneEl.addEventListener('error', function(err) {
        document.querySelector('.loading').textContent = 'Error: Failed to initialize AR. Check targets.mind file path.';
        document.querySelector('.loading').style.background = 'rgba(128,0,0,0.9)';
        console.error('MindAR error:', err);
      });
      
      // Hide loading screen after scene loads
      sceneEl.addEventListener('loaded', function() {
        document.querySelector('.loading').style.display = 'none';
      });

      // Handle video autoplay on detection
      const videoEls = document.querySelectorAll('a-video');
      sceneEl.addEventListener('targetFound', (event) => {
        videoEls.forEach(video => {
          if(video.components.material && video.components.material.material.map.image.paused) {
            video.components.material.material.map.image.play();
          }
        });
      });
      sceneEl.addEventListener('targetLost', (event) => {
        videoEls.forEach(video => {
          if(!video.components.material.material.map.image.paused) {
            video.components.material.material.map.image.pause();
          }
        });
      });
    });
  </script>
</body>
</html>`;
      };
      
      const generateInstructions = () => {
        return `
# AR Project Deployment Instructions

Thank you for using the WebAR Editor! Here is how to deploy your augmented reality experience:

## 1. Project Files
The downloaded ZIP file contains:
- \`ar-experience.html\`: The main A-Frame/MindAR file.
- \`README.md\`: This instruction file.
- \`targets.mind\` (Placeholder): **YOU MUST REPLACE THIS FILE.**
- \`motion-card.gif\` (Placeholder): **YOU MUST REPLACE THIS FILE.**

## 2. Generate Your Target File (\`targets.mind\`)

The \`targets.mind\` file is essential for MindAR to recognize your uploaded target image.
1.  Go to the official MindAR online compiler (or the tool you use).
2.  Upload your **Target Image** that you used in the editor (the one you see in the canvas).
3.  Download the resulting \`targets.mind\` file.

## 3. Replace Placeholder Files
In the folder you created for your AR experience:
-   **Delete** the placeholder \`targets.mind\` file.
-   **Move** your newly generated \`targets.mind\` file into the folder.
-   **Delete** the placeholder \`motion-card.gif\` file.
-   **Move** your actual \`motion-card.gif\` file into the folder (or whatever file name you used in the editor's URL field).

## 4. Hosting
Upload all the project files (including \`ar-experience.html\`, \`targets.mind\`, \`motion-card.gif\`, and any other assets you used) to a **web server** (e.g., Netlify, GitHub Pages, your company's server).
*MindAR requires a secure context (HTTPS) for the camera to work, so ensure your site is hosted on HTTPS.*

## 5. Testing
Open the \`ar-experience.html\` file via its hosted URL on a mobile device to test your AR experience!

If you used external URLs for assets, you only need to upload \`ar-experience.html\`, \`targets.mind\`, and \`motion-card.gif\`.
        `;
      };
      
      const handleProjectDownload = async () => {
        if (!targetImage) {
          alert('Please upload a Target Image before generating the project package.');
          return;
        }
        if (elements.length === 0) {
           alert('Please add at least one AR element before generating the project package.');
           return;
        }

        const zip = new JSZip();

        // 1. Generate HTML Content using the current paths from state
        const htmlContent = generateHTML(targetsMindUrl, motionCardUrl);
        zip.file("ar-experience.html", htmlContent);
        
        // 2. Generate Instructions
        zip.file("README.md", generateInstructions());
        
        // 3. Add placeholders for required external user files (targets.mind and motion-card.gif)
        zip.file("targets.mind", "This is a placeholder file. Replace this with the targets.mind file generated from your uploaded target image. See README.md for instructions.");
        zip.file("motion-card.gif", "This is a placeholder file. Replace this with your actual motion-card.gif file.");

        // 4. Generate and trigger ZIP download
        zip.generateAsync({type:"blob"})
           .then(function(content) {
             const url = URL.createObjectURL(content);
             const a = document.createElement('a');
             a.href = url;
             a.download = 'ar-project-package.zip';
             a.click();
             URL.revokeObjectURL(url);
           });
      };

      const selected = elements.find(el => el.id === selectedElement);

      return (
        <div className="min-h-screen bg-gray-900 text-white">
          {/* Header */}
          <div className="bg-gray-800 border-b border-gray-700 p-4">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold">WebAR Editor</h1>
                <p className="text-sm text-gray-400">Build AR experiences without coding</p>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={exportProject}
                  className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded flex items-center gap-2 transition"
                >
                  <Download size={18} />
                  Export Editor State (JSON)
                </button>
                <button
                  onClick={handleProjectDownload} // Use the new function to generate ZIP
                  className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded flex items-center gap-2 transition"
                  disabled={!targetImage || elements.length === 0}
                >
                  <Download size={18} />
                  Generate AR Project (ZIP)
                </button>
              </div>
            </div>
          </div>

          {/* Main Content */}
          <div className="flex h-[calc(100vh-89px)]">
            {/* Sidebar - Toolbox */}
            <div className="w-64 bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto">
              <h2 className="text-lg font-semibold mb-4">Toolbox</h2>
              
              {/* Target Image Upload */}
              <div className="mb-6">
                <label className="block text-sm font-medium mb-2">Target Image</label>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleImageUpload}
                  className="hidden"
                />
                <button
                  onClick={() => fileInputRef.current.click()}
                  className="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded flex items-center justify-center gap-2 transition"
                >
                  <Upload size={18} />
                  Upload Target
                </button>
                {targetImage && (
                  <div className="mt-2">
                    <img src={targetImage} alt="Target" className="w-full rounded border border-gray-600" />
                  </div>
                )}
              </div>
              
              {/* AR Project File Paths */}
              <div className="mb-6 border-t border-gray-700 pt-4">
                  <label className="block text-sm font-medium mb-2">AR Config Paths</label>
                  <div className="space-y-3">
                      <div>
                          <label className="block text-xs text-gray-400 mb-1">Target Mind File Path (e.g. \`targets.mind\`)</label>
                          <input
                              type="text"
                              value={targetsMindUrl}
                              onChange={(e) => setTargetsMindUrl(e.target.value)}
                              className="w-full px-3 py-2 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none text-sm"
                          />
                      </div>
                      <div>
                          <label className="block text-xs text-gray-400 mb-1">Motion Card GIF Path (e.g. \`motion-card.gif\`)</label>
                          <input
                              type="text"
                              value={motionCardUrl}
                              onChange={(e) => setMotionCardUrl(e.target.value)}
                              className="w-full px-3 py-2 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none text-sm"
                          />
                      </div>
                  </div>
              </div>


              {/* Add Elements */}
              <div className="space-y-2 border-t border-gray-700 pt-4">
                <label className="block text-sm font-medium mb-2">Add Elements</label>
                <button
                  onClick={() => addElement('image')}
                  className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded flex items-center gap-2 transition"
                >
                  <Image size={18} />
                  Image
                </button>
                <button
                  onClick={() => addElement('video')}
                  className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded flex items-center gap-2 transition"
                >
                  <Video size={18} />
                  Video
                </button>
                <button
                  onClick={() => addElement('model')}
                  className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded flex items-center gap-2 transition"
                >
                  <Box size={18} />
                  3D Model (GLTF)
                </button>
                <button
                  onClick={() => addElement('text')}
                  className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded flex items-center gap-2 transition"
                >
                  <Type size={18} />
                  Text
                </button>
              </div>

              {/* Elements List */}
              <div className="mt-6">
                <label className="block text-sm font-medium mb-2">Elements ({elements.length})</label>
                <div className="space-y-1">
                  {elements.map(el => (
                    <div
                      key={el.id}
                      className={`p-2 rounded flex items-center justify-between cursor-pointer transition ${
                        selectedElement === el.id ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'
                      }`}
                      onClick={() => setSelectedElement(el.id)}
                    >
