<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enigma AR Experience</title>

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- A-Frame and MindAR (deferred to avoid blocking) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js" defer></script>

  <style>
    html,body {
      height:100%;
      margin:0;
      background:#000;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Safe area and full-screen scene */
    a-scene, #ar-root {
      width:100%;
      height:100%;
      position:fixed;
      inset:0;
    }

    /* Instruction box */
    #ar-instructions {
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      z-index:9999; /* Increased Z-index for guaranteed clickability */
      background:rgba(17,24,39,0.88); /* dark bg */
      color:#fff;
      padding:1.25rem;
      border-radius:12px;
      text-align:center;
      pointer-events:auto; /* allow taps */
      box-shadow:0 10px 30px rgba(2,6,23,0.6);
      transition:opacity .35s ease, transform .25s ease;
      max-width:90%;
    }

    #start-btn {
      margin-top:0.75rem;
      display:inline-block;
      background:linear-gradient(90deg,#06b6d4,#3b82f6);
      color:#fff;
      padding:.5rem 1rem;
      border-radius:8px;
      border:0;
      font-weight:600;
      font-size:1rem;
      cursor: pointer;
    }

    #status {
      margin-top:0.5rem;
      font-size:.9rem;
      color:#d1d5db;
    }

    /* Respect reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
      .spin-animation {
        animation: none !important;
      }
    }

    /* Hidden utility */
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div id="ar-root">
    <a-scene
      embedded
      mindar-image="autoStart: false; imageTargetSrc: ./targets.mind; filterMinCF: 0.0001; filterBeta: 10000;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights: true"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <!-- Example AR Content: A spinning, semi-transparent red cube -->
        <a-box
          id="cube"
          class="spin-animation"
          position="0 0 0.5"
          rotation="0 0 0"
          scale="0.3 0.3 0.3"
          material="color: #ff3b30; opacity: 0.9; metalness: 0.5; roughness: 0.2"
          animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"
        ></a-box>

        <a-text
          value="ENIGMA DIGITAL"
          position="0 0.5 0.5"
          align="center"
          color="#ffffff"
          width="1.5"
        ></a-text>
      </a-entity>
    </a-scene>
  </div>

  <!-- Instructions & controls -->
  <div id="ar-instructions" role="region" aria-live="polite" aria-atomic="true">
    <div style="font-weight:700; font-size:1.125rem">AR Experience Ready</div>
    <div style="margin-top:.25rem; color:#d1d5db">Point your camera at the Enigma business card when ready.</div>

    <button id="start-btn" aria-label="Start augmented reality">Start AR</button>
    <div id="status" aria-hidden="false">Tap "Start AR" to begin â€” camera permission will be requested.</div>
    <div id="error" class="hidden" role="alert" style="color:#ffb4b4; margin-top:.5rem;"></div>
  </div>

  <script>
    (function () {
      const startBtn = document.getElementById('start-btn');
      const status = document.getElementById('status');
      const errorEl = document.getElementById('error');
      const instructions = document.getElementById('ar-instructions');
      let mindarComponent = null;
      let scene = null;

      function log(msg) {
        console.debug('[ENIGMA AR]', msg);
      }

      function init() {
        // Try to get the scene and MindAR component now that all scripts are loaded.
        scene = document.querySelector('a-scene');
        mindarComponent = scene ? scene.components['mindar-image'] : null;

        if (!mindarComponent) {
            errorEl.classList.remove('hidden');
            errorEl.textContent = 'AR library failed to load. Check network connection.';
            console.error('MindAR component missing after window load.');
            return;
        }


        // --- Event Listeners for MindAR State ---
        scene.addEventListener('arReady', () => {
            log('MindAR is ready.');
            instructions.style.opacity = '0.85';
        });
        
        scene.addEventListener('arError', (event) => {
          console.error('[MINDAR AR ERROR]', event);
          errorEl.classList.remove('hidden');
          errorEl.textContent = 'AR Failed to Start (Check targets.mind file).';
          status.textContent = 'Initialization Failed';
        });


        const targetEntity = document.querySelector('a-entity[mindar-image-target]');
        if (targetEntity) {
            targetEntity.addEventListener('targetFound', () => {
                log('targetFound');
                instructions.style.opacity = '0'; // Hide on successful tracking
            });
            targetEntity.addEventListener('targetLost', () => {
                log('targetLost');
                instructions.style.opacity = '1'; // Show on tracking loss
            });
        }
        // --- END Event Listeners ---


        // --- Button Click Handler ---
        startBtn.addEventListener('click', async () => {
          errorEl.classList.add('hidden');
          status.textContent = 'Requesting camera permissionâ€¦';

          try {
            // iOS 13+ motion permission check
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
              try {
                await DeviceOrientationEvent.requestPermission();
              } catch (e) {
                log('DeviceOrientation permission request dismissed.');
              }
            }

            // Start MindAR
            await mindarComponent.start();
            status.textContent = 'AR started â€” point your camera at the card.';
            startBtn.blur(); // Remove focus

          } catch (err) {
            console.error('AR START ERROR:', err);
            errorEl.classList.remove('hidden');
            errorEl.textContent = 'Could not start AR. Camera permission denied or device not supported.';
            status.textContent = 'Start failed';
          }
        });
        // --- END Button Click Handler ---
      }

      // ðŸš¨ CRITICAL FIX: Initialize after the full window and all deferred scripts are loaded
      window.addEventListener('load', init, { once: true });
    })();
  </script>
</body>
</html>

