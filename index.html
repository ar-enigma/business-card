<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigma AR Experience (Three.js)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Mobile-first styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: white;
            padding: 20px;
            overflow: hidden; 
        }
        .container {
            max-width: 400px;
            width: 100%;
            padding: 30px;
            background-color: #161b22;
            border-radius: 12px;
            box-shadow: 0 4px 60px rgba(0, 200, 255, 0.2);
            text-align: center;
            position: relative;
            z-index: 10;
        }
        .error-box {
            background-color: #330c0c;
            border: 1px solid #ff4d4d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .success-box {
            background-color: #0c3316;
            border: 1px solid #4dff4d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        /* Canvas is hidden until AR starts */
        #arCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none; 
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <h1 class="text-xl font-bold mb-4">Enigma AR Experience</h1>
        <p class="text-sm text-gray-400 mb-6">Tap Start to activate your camera for image tracking.</p>

        <button id="startButton" 
                class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out">
            Start AR Experience
        </button>

        <div id="statusMessage" class="success-box mt-4">
            <p id="errorText" class="font-mono text-xs">Loading AR scripts from CDN...</p>
        </div>
    </div>
    
    <!-- The canvas where Three.js will render the AR scene -->
    <canvas id="arCanvas"></canvas>

    <script type="module">
        // --- USING STABLE CDN IMPORTS TO BYPASS LOCAL FILE/NAMING/CASE ERRORS ---
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.module.js'; 
        import { MindARThree } from 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-image-three.prod.js'; 
        // ----------------------------------------------------------------------

        const startButton = document.getElementById('startButton');
        const arCanvas = document.getElementById('arCanvas');
        const mainContainer = document.getElementById('mainContainer');
        const statusMessage = document.getElementById('statusMessage');
        const errorText = document.getElementById('errorText');
        
        // --- Utility Functions ---
        const showError = (message) => {
            statusMessage.classList.remove('hidden', 'success-box');
            statusMessage.classList.add('error-box');
            errorText.innerText = message;
        }

        const showSuccess = (message) => {
            statusMessage.classList.remove('hidden', 'error-box');
            statusMessage.classList.add('success-box');
            errorText.innerText = message;
        }
        
        // --- Core AR Initialization Function ---
        const initializeAR = async () => {
            // Hide startup UI and show canvas
            mainContainer.style.display = 'none';
            document.body.style.backgroundColor = 'black';
            arCanvas.style.display = 'block';

            showSuccess("Starting AR Engine. Waiting for camera permission request...");

            try {
                // Initialize MindAR
                const mindarThree = new MindARThree({
                    container: arCanvas,
                    imageTargetSrc: 'targets.mind',
                    filterMinCF: 0.0001, 
                    filterBeta: 0.001,
                    maxTrack: 2
                });
                
                const { renderer, scene, camera } = mindarThree;

                // Create a 3D object (red cube)
                const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
                const material = new THREE.MeshPhongMaterial({ color: 0xFF0000 });
                const cube = new THREE.Mesh(geometry, material);
                
                // Lighting
                const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
                scene.add(light);

                // Attach cube to the first anchor
                const anchor = mindarThree.addAnchor(0); 
                anchor.group.add(cube); 

                // Start AR tracking (Camera prompt happens here)
                await mindarThree.start();

                showSuccess("AR Activated! Point the camera at your Enigma business card.");

                // Animation loop
                renderer.setAnimationLoop(() => {
                    renderer.render(scene, camera);
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;
                });

            } catch (error) {
                console.error("MindAR Initialization Error:", error);
                
                // Show the start screen again with the error
                document.body.style.backgroundColor = '#0d1117';
                mainContainer.style.display = 'block';
                arCanvas.style.display = 'none';

                if (error.name === 'NotAllowedError' || error.message.includes('WebAssembly')) {
                    // This is the Cross-Origin Isolation error we have been fighting. 
                    // Netlify should prevent this, but if it still shows, it's a device issue.
                    showError("CRITICAL: Camera blocked by browser security (COOP/COEP failed). This must be a browser/device security policy issue. Please check your browser's console for exact errors.");
                } else if (error.name === 'NotFoundError') {
                    showError("Start Failed: Camera not found on this device.");
                } else {
                    showError(`An unexpected error occurred: ${error.message}`);
                }
            }
        };

        startButton.addEventListener('click', initializeAR);
        
        // Initial check now only confirms the page loaded
        window.addEventListener('load', () => {
            showSuccess("Page loaded. Click Start to begin.");
        });

    </script>
</body>
</html>
