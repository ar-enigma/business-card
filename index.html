<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>‚Å∑Wake up to Reality</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #note,
        #markerStatus {
            position: absolute;
            z-index: 2;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        #note {
            left: 8px;
            top: 8px;
            background: rgba(0, 0, 0, 0.65);
        }

        #markerStatus {
            right: 8px;
            top: 8px;
            background: rgba(200, 0, 0, 0.7);
        }

        #markerStatus.found {
            background: rgba(0, 150, 0, 0.7);
        }
    </style>
</head>

<body>
    <div id="note">
        Point your camera at the <strong>Image Target</strong>.<br>
        Allow camera access when prompted.
    </div>

    <div id="markerStatus">Target Not Found</div>

    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            filterMinCF:0.0001; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              filterBeta:0.01;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                warmupTolerance:5;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  missTolerance:5;"
        color-space="sRGB" renderer="colorManagement:true; physicallyCorrectLights:true;" vr-mode-ui="enabled:false"
        device-orientation-permission-ui="enabled:false">

        <a-assets>
            <video id="bottomVideo" src="./assets/motion-card.mp4" preload="auto" loop="true" playsinline
                crossorigin="anonymous" webkit-playsinline="true" muted>
                <source src="./assets/motion-card.webm" type="video/webm">
            </video>

            <img id="callIconImg"
                src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><rect width='48' height='48' rx='12' fill='%23007AFF'/><path fill='white' d='M34.1 31.6l-4.9-.8c-.7-.1-1.4.1-1.9.6l-3.1 3.1c-4.9-2.5-8.9-6.5-11.4-11.4l3.1-3.1c.5-.5.7-1.2.6-1.9l-.8-4.9c-.2-1.2-1.3-2.1-2.5-2.1H10c-1.4 0-2.6 1.2-2.5 2.6C8 27 21 40 34.4 40c1.4 0 2.6-1.1 2.6-2.5v-3.5c0-1.2-.9-2.3-2.9-2.4z'/></svg>">
            <img id="webIconImg"
                src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><rect width='48' height='48' rx='12' fill='%23FF6D00'/><circle cx='24' cy='24' r='14' stroke='white' stroke-width='3' fill='none'/><path stroke='white' stroke-width='3' fill='none' d='M24 10v28M10 24h28'/></svg>">
            <img id="emailIconImg"
                src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><rect width='48' height='48' rx='12' fill='%2306C755'/><path fill='white' d='M6 12l18 13.5L42 12v-2H6v2zm0 6v16h36V18l-18 13.5L6 18z'/></svg>">

            <img id="fbIconImg"
                src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><rect width='48' height='48' rx='12' fill='%231877F2'/><path fill='white' d='M28 16h4.5V10H28c-5.5 0-8 3-8 8v4h-4v6h4v10h6V28h4.5l1.5-6H26v-3c0-1.5 1.2-3 2-3z'/></svg>">
            <img id="igIconImg"
                src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 24 24' fill='white'><rect width='24' height='24' rx='4' fill='%23E1306C'/><path d='M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5zm5 5a5 5 0 100 10 5 5 0 000-10zm6.5-.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z'/></svg>">
            <img id="lnIconImg"
                src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><rect width='48' height='48' rx='12' fill='%230A66C2'/><rect x='10' y='18' width='6' height='20' fill='white'/><circle cx='13' cy='12.5' r='3.5' fill='white'/><path fill='white' d='M22 18h6v3c1-2 3.5-3.5 6.5-3.5C39 17.5 42 20 42 26.5V38h-6V27c0-3-1.5-4.5-3.5-4.5S29 24 29 27v11h-7V18z'/></svg>">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled:false" cursor="fuse:false; rayOrigin:mouse;"
            raycaster="objects:.clickable">
        </a-camera>

        <a-entity id="mainMarker" mindar-image-target="targetIndex:0">

            <a-plane id="bottomVideoPlane" class="clickable" position="0 0 0.0" rotation="0 0 0" width="1.6"
                height="0.9" material="src: #bottomVideo; shader: flat;" visible="false">
            </a-plane>

            <a-plane id="callBtnAR" class="clickable" position="-0.65 0.22 0.01" width="0.20" height="0.20"
                material="src:#callIconImg; transparent:true;" link-trigger="action: call" visible="false"></a-plane>
            <a-plane id="websiteBtnAR" class="clickable" position="-0.65 -0.00 0.01" width="0.20" height="0.20"
                material="src:#webIconImg; transparent:true;" link-trigger="action: website" visible="false"></a-plane>
            <a-plane id="emailBtnAR" class="clickable" position="-0.65 -0.22 0.01" width="0.20" height="0.20"
                material="src:#emailIconImg; transparent:true;" link-trigger="action: email" visible="false"></a-plane>

            <a-plane id="fbBtnAR" class="clickable" position="0.65 0.22 0.01" width="0.20" height="0.20"
                material="src:#fbIconImg; transparent:true;" link-trigger="action: facebook" visible="false"></a-plane>
            <a-plane id="igBtnAR" class="clickable" position="0.65 0.00 0.01" width="0.20" height="0.20"
                material="src:#igIconImg; transparent:true;" link-trigger="action: instagram" visible="false"></a-plane>
            <a-plane id="lnBtnAR" class="clickable" position="0.65 -0.22 0.01" width="0.20" height="0.20"
                material="src:#lnIconImg; transparent:true;" link-trigger="action: linkedin" visible="false"></a-plane>
        </a-entity>

        <a-entity light="type:ambient; intensity:1; color:#ffffff"></a-entity>
    </a-scene>

    <script>
        const sceneEl = document.querySelector('a-scene');
        const markerEl = document.getElementById('mainMarker');
        const markerStatus = document.getElementById('markerStatus');
        const bottomVideoPlane = document.getElementById('bottomVideoPlane');
        const bottomVideo = document.getElementById('bottomVideo');

        bottomVideo.load();

        AFRAME.registerComponent('link-trigger', {
            schema: { action: { type: 'string' } },
            init: function () {
                this.el.addEventListener('click', () => {
                    const action = this.data.action;
                    if (action === 'call') window.location.href = 'tel:+923161038953';
                    else if (action === 'website') window.open('https://enigmamarketing.pk', '_blank');
                    else if (action === 'email') window.open('mailto:info@enigmamarketing.pk', '_blank');
                    else if (action === 'facebook') window.open("https://www.facebook.com/enigmamarketing.pk/", "_blank");
                    else if (action === 'instagram') window.open("https://www.instagram.com/enigmamarketing.pk/", "_blank");
                    else if (action === 'linkedin') window.open("https://www.linkedin.com/company/enigma-digital-marketing-it-solutions", "_blank");
                });
            }
        });

        bottomVideoPlane.addEventListener('click', () => {
            if (bottomVideo.paused) bottomVideo.play();
            else bottomVideo.pause();
        });

        function refreshRaycaster() {
            const cam = document.querySelector('a-camera');
            if (cam && cam.components.raycaster && cam.components.raycaster.refreshObjects) {
                try { cam.components.raycaster.refreshObjects(); }
                catch (e) { console.warn('raycaster.refreshObjects failed:', e); }
            }
        }

        markerEl.addEventListener('targetFound', () => {
            markerStatus.classList.add('found');
            markerStatus.textContent = 'Target Found';

            document.querySelectorAll('#mainMarker .clickable').forEach(el => el.setAttribute('visible', true));
            bottomVideoPlane.setAttribute("visible", true);

            bottomVideo.play().catch(() => { });

            setTimeout(refreshRaycaster, 120);
        });

        markerEl.addEventListener('targetLost', () => {
            markerStatus.classList.remove('found');
            markerStatus.textContent = 'Target Not Found';

            document.querySelectorAll('#mainMarker .clickable, #bottomVideoPlane').forEach(el => el.setAttribute('visible', false));

            bottomVideo.pause();
            bottomVideo.currentTime = 0;
        });

        sceneEl.addEventListener('arReady', () => console.log('MindAR ready'));
        sceneEl.addEventListener('arError', e => console.error('MindAR error:', e.detail));

        (function setupManualRaycast() {
            const THREE = AFRAME.THREE;
            const raycaster = new THREE.Raycaster();
            const camEl = document.querySelector('a-camera');

            function getIntersections(clientX, clientY) {
                const x = (clientX / window.innerWidth) * 2 - 1;
                const y = -(clientY / window.innerHeight) * 2 + 1;
                const threeCamera = camEl.getObject3D('camera');
                if (!threeCamera) return [];
                raycaster.setFromCamera({ x, y }, threeCamera);
                const clickableEls = [...document.querySelectorAll('.clickable')];
                const meshes = clickableEls.map(el => ({ el, mesh: el.getObject3D('mesh') })).filter(obj => obj.mesh);
                const intersections = raycaster.intersectObjects(meshes.map(m => m.mesh), true);
                if (intersections.length === 0) return [];
                for (let inter of intersections) {
                    for (let m of meshes) {
                        let current = inter.object;
                        while (current) {
                            if (current === m.mesh) return [m.el, inter];
                            current = current.parent;
                        }
                    }
                }
                return [];
            }

            function onPointerDown(evt) {
                const cx = evt.touches ? evt.touches[0].clientX : evt.clientX;
                const cy = evt.touches ? evt.touches[0].clientY : evt.clientY;
                const hit = getIntersections(cx, cy);
                if (hit.length) {
                    const el = hit[0];
                    if (el !== bottomVideoPlane) {
                        evt.preventDefault();
                        evt.stopPropagation();
                    }
                    el.emit('click', null, false);
                    el.object3D.scale.set(0.95, 0.95, 0.95);
                    setTimeout(() => el.object3D.scale.set(1, 1, 1), 120);
                }
            }

            window.addEventListener('pointerdown', onPointerDown, { passive: false });
            window.addEventListener('touchstart', onPointerDown, { passive: false });
            console.log('Manual raycast handler installed');
        })();
    </script>
</body>

</html>